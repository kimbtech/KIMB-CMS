function show_error(tit,mes,dom){$(dom).html('<div class="ui-widget"><div class="ui-state-error ui-corner-all" style="padding: 5px;"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span><span style="margin-left:10px;"><strong>'+tit+'</strong>&nbsp;&nbsp;&nbsp;'+mes+'</span></div></div>');return !0}
function htmlspecialchars(str){if(typeof(str)=="string"){str=str.replace(/&/g,"&amp;");str=str.replace(/"/g,"&quot;");str=str.replace(/'/g,"&#039;");str=str.replace(/</g,"&lt;");str=str.replace(/>/g,"&gt;")}
return str}
function inline2Blob(inline){var byte;if(inline.split(',')[0].indexOf('base64')>=0){byte=atob(inline.split(',')[1])}
else{byte=unescape(inline.split(',')[1])}
var mime=inline.split(',')[0].split(':')[1].split(';')[0];var array=new Uint8Array(byte.length);for(var i=0;i<byte.length;i++){array[i]=byte.charCodeAt(i)}
return new Blob([array],{type:mime})}
$(function(){var loader='<div id="daten_loading"  style="display:none;">';loader+='<div style="position:fixed; top:0; left:0; z-index:50; background-color:gray; opacity:0.5; width:100%; height:100%;">';loader+='</div>';loader+='<div style="position:fixed; top:calc( 50% - 64px ); left:calc( 50% - 64px ); background-color:#5d7; border-radius:20px; padding:15px; z-index:51;">';loader+='<img src="'+add_daten.siteurl+'/load/system/spin_load.gif" title="Lädt!!" alt="Lädt!!">';loader+='</div>';loader+='</div>';$('body').append(loader);$("#daten_loading").hide("highlight");$(document).bind("ajaxSend",function(){$("#daten_loading").show("highlight")}).bind("ajaxComplete",function(){$("#daten_loading").hide("highlight")})});Dropzone.autoDiscover=!1;function j_alert(meld,dw){if(typeof dw==='undefined'){dw=300}
if($("div.j_alert").length){$("div.j_alert").remove()}
var dial='<div class="j_alert" title="Wichtig!!">'
dial+=meld;dial+='</div>';$("body").prepend(dial);$("div.j_alert").dialog({modal:!0,width:dw,responsive:!0,buttons:{"OK":function(){$(this).dialog('close')}}})}
$(function(){load_daten()});var cssclass="div.addon_daten_main ";function load_daten(){$(cssclass).html('<h2>Dateiverwaltung</h2>'+'<div id="firstbutt">'+'<input type="radio" name="firstbutt" id="my" checked="checked"><label for="my">Mein Verzeichnis</label>'+'<input type="radio" name="firstbutt" id="pu"><label for="pu">Für alle User</label>'+'<input type="radio" name="firstbutt" id="frei"><label for="frei">Freigaben</label>'+'</div>'+'<div class="main_files">Bitte wählen Sie einen Ort &uarr;</div>');$("div#firstbutt").buttonset();$("#firstbutt input[type=radio]").click(function(){set_vars($(this).attr('id'))});var id=window.location.hash;if(id==''){set_vars('my')}
else{if(id.substr(0,7)=='#user:/'){set_vars('my',id.substr(7))}
else if(id.substr(0,9)=='#public:/'){set_vars('pu',id.substr(9));$("#firstbutt input[type=radio]#pu").attr("checked","checked")
$("div#firstbutt").buttonset("refresh")}
else if(id=="#freig://list"){set_vars('frei')}
else{set_vars('my')}}}
var allgvars=new Object;function set_vars(ort,path){if(typeof path=="undefined"){path='/'}
if(ort=='my'){allgvars.folder='user';allgvars.path=path;allgvars.proto='my:/'
main_explorer()}
else if(ort=='pu'){allgvars.folder='public';allgvars.path=path;allgvars.proto='pub:/'
main_explorer()}
else if(ort=='frei'){show_freigaben()}
else{return !1}}
function main_explorer(){$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"filelist"}).always(function(data){window.location.hash=allgvars.folder+":/"+allgvars.path;var html='<div class="toolbar">'+'<button id="add_table">Neue Tabelle</button>'+'<button id="add_file">Neue Datei</button>'+'<button id="add_folder">Neuer Ordner</button>'+' &mdash; '+'<button id="zwisch">Zwischenablage</button>'+'<br />'+'<span class="input" style="display:none;">'+'<input type="text" id="new_name" placeholder="Name">'+'<small>Enter zum Speichern; Ctrl zum Abbrechen; Dateien gleichen Namens werden überschrieben</small>'+'</span>'+'</div>';html+='<div class="pathbarumg">';html+='<button id="oneup"><span class="ui-icon ui-icon-arrowthick-1-w"></span></button>';var pathbardata='';var path='';var pathbardata_ar=allgvars.path.split('/');$.each(pathbardata_ar,function(k,v){if(v!=''){path+='/'+v;pathbardata+='</span>/<span class="pathslash" path="'+path+'/">';pathbardata+=v}});pathbardata=pathbardata.substr(7);if(pathbardata==''){pathbardata='/'}
html+='<div class="pathbar">'+allgvars.proto+pathbardata+'</div>';html+='</div>';if(typeof data.main=="undefined"){j_alert("Der Sever antwortet nicht korrekt!");return}
data=data.main;var folder_ex=data.folder_ex;data=data.filelist;if(data!=null){html+='<ul class="files">';var elements=0;$.each(data,function(k,v){var icon;if(v.type=='dir'){icon='folder-collapsed'}
else if(v.type=='file'){icon='document'}
else if(v.type=='kt'){icon='calculator'}
else{icon='blank'}
html+='<li url="'+v.url+'" ftype="'+v.type+'" name="'+v.name+'"><span class="ui-icon ui-icon-'+icon+'" style="display:inline-block;"></span>'+v.name+'</li>';elements++});if(elements==0){html+='<li>Der Ordner ist leer!</li>'}
html+='</ul>';html+='<small>Rechtsklick auf Datei oder Ordner zum Löschen, Kopieren, Verschieben, Umbenennen oder Freigeben</small>';if(folder_ex){$("div.main_files").html(html);$('span.pathslash').unbind('click').click(function(){var path=$(this).attr('path');allgvars.path=path;main_explorer()});$('button#oneup').unbind('click').click(function(){if(allgvars.path[(allgvars.path.length-1)]=='/'){allgvars.path=allgvars.path.substr(0,(allgvars.path.length-1))}
var slash=allgvars.path.lastIndexOf("/");if(slash==-1||slash==0){allgvars.path='/'}
else{allgvars.path=allgvars.path.substr(0,slash);allgvars.path+='/'}
main_explorer()});$('ul.files li').unbind('click').click(function(){if(shall_do_fileload()){var ftype=$(this).attr('ftype');var url=$(this).attr('url');var name=$(this).attr('name');if(ftype=='dir'){allgvars.path=allgvars.path+url+'/';main_explorer()}
else if(ftype=='file'){open_file(url)}
else if(ftype=='kt'){open_table(url,name)}}});$("button#add_table").unbind('click').click(function(){$("div.toolbar span").css('display','inline');$("div.toolbar span input").unbind('keyup').keyup(function(event){if(event.keyCode==13){var name=$(this).val();var url=name+'.kimb_table';open_table(url,name,!0);$("div.toolbar span").css('display','none')}
else if(event.keyCode==17){$("div.toolbar span").css('display','none')}})});$("button#add_file").unbind('click').click(function(){var html='<h2>Dateien hochladen</h2>';html+='<form action="'+add_daten.siteurl+'/ajax.php?addon=daten" class="dropzone" id="dropzone">';html+='<input type="hidden" name="allgvars[folder]" value="'+allgvars.folder+'">';html+='<input type="hidden" name="allgvars[path]" value="'+allgvars.path+'">';html+='<input type="hidden" name="todo" value="uploadfile">';html+='<img src="'+add_daten.siteurl+'/load/addondata/daten/upload.png" style="display: block; margin:auto;" title="Ziehen Sie zum Hochladen Dateien über dieses Feld oder klicken Sie!" class="dz-message">';html+='</form>';html+='<div id="kimb_enc_outer">';html+='<input type="checkbox" id="kimb_enc_oo"> Dateien verschlüsseln';html+='<div id="kimb_enc_div" style="display:none;">';html+='<input type="password" id="kimb_enc_passw" placeholder="Passwort"><br />';html+='<small><input type="checkbox" id="kimb_enc_klar"> Klartext</small><br />';html+='<small>Geben Sie ein Passwort zu Verschlüsselung der Dateien an.</small><br />';html+='<small>Alle verschlüsselten Dateien erhalten die Endung <code>.kimb_enc</code> und können nur mit Passwort heruntergeladen werden.</small>';html+='</div>';html+='</div>';j_alert(html,600);$("input#kimb_enc_oo").change(function(){if($("input#kimb_enc_oo:checked").length==1){$("div#kimb_enc_div").css("display","block")}
else{$("div#kimb_enc_div").css("display","none")}});$("input#kimb_enc_klar").change(function(){if($("input#kimb_enc_klar:checked").length==1){$("input#kimb_enc_passw").attr("type","text")}
else{$("input#kimb_enc_passw").attr("type","password")}});var ExplorerDropzone=new Dropzone("form#dropzone");ExplorerDropzone.on("queuecomplete",function(file){main_explorer()});ExplorerDropzone.on("addedfile",function(file){if($("input#kimb_enc_oo:checked").length==1){var pass=$("input#kimb_enc_passw").val();if(pass!=""){var id=btoa(file.name);id=id.replace(/([^A-Za-z])/g,'');var successmark='<div class="dz-success-mark"><svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns"><title>Check</title><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"><path d="M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" stroke-opacity="0.198794158" stroke="#747474" fill-opacity="0.816519475" fill="#FFFFFF" sketch:type="MSShapeGroup"></path></g></svg></div>';var errormark='<div class="dz-error-mark"><svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns"><title>Error</title><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"><g id="Check-+-Oval-2" sketch:type="MSLayerGroup" stroke="#747474" stroke-opacity="0.198794158" fill="#FFFFFF" fill-opacity="0.816519475"><path d="M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" sketch:type="MSShapeGroup"></path></g></g></svg></div>';var reader=new FileReader();reader.addEventListener("load",function(){var data=reader.result;data=sjcl.encrypt(pass,data);data=new Blob([data],{type:'application/json'});var formd=new FormData();formd.append("allgvars[folder]",allgvars.folder);formd.append("allgvars[path]",allgvars.path);formd.append("todo","uploadfile");formd.set("file",data,file.name+".kimb_enc");$.ajax({url:add_daten.siteurl+'/ajax.php?addon=daten',dataType:'json',cache:!1,contentType:!1,processData:!1,data:formd,type:'post'}).always(function(data){if(typeof data=="object"&&typeof data.main!="undefined"&&typeof data.main.wr!="undefined"&&data.main.wr==!0){$("div#"+id).find("img").removeAttr("src");$("div#"+id).find("div.marks").html(successmark);$("div#"+id).find("div.dz-success-mark").css("opacity","1")}
else{$("div#"+id).find("img").removeAttr("src");$("div#"+id).find("div.marks").html(errormark);$("div#"+id).find("div.dz-error-mark").css("opacity","1")}
if(typeof data.main!="undefined"){main_explorer()}})},!1);reader.readAsDataURL(file);ExplorerDropzone.removeFile(file);$("form#dropzone").append('<div class="dz-preview dz-file-preview" id="'+id+'">'+'<div class="dz-image"><img data-dz-thumbnail src="'+add_daten.siteurl+'/load/system/spin_load.gif" /></div>'+'<div class="dz-details">'+'<div class="dz-filename"><span data-dz-name>'+file.name+'</span></div>'+'</div>'+'<div class="marks"></div>'+'</div>')}}})});$("button#add_folder").unbind('click').click(function(){$("div.toolbar span").css('display','inline');$("div.toolbar span input").unbind('keyup').keyup(function(event){if(event.keyCode==13){var name=$(this).val();allgvars.file=name;$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"newfolder"}).always(function(data){if(data!=null&&data.main!=null&&data.main.wr){main_explorer()}
else{j_alert("Das Erstellen der Ordners ist fehlgeschlagen!")}});$("div.toolbar span").css('display','none')}
else if(event.keyCode==17){$("div.toolbar span").css('display','none')}})});$("button#zwisch").unbind('click').click(makezwischenablagedial);function makezwischenablagedial(){var zwisch=localStorage.getItem("daten_zwischenablage");zwisch=JSON.parse(zwisch);if($("div.zwischenablage").length){$("div.zwischenablage").remove()}
var dial='<div class="zwischenablage" title="Zwischenablage">'
dial+='<table>';dial+='<tr>';dial+='<th>Art</th>';dial+='<th>Name</th>';dial+='<th>Einfügen</th>'
dial+='<th>Löschen</th>';dial+='<th>Pfad</th>';dial+='</tr>';if(zwisch!=null&&typeof zwisch=="object"){$.each(zwisch,function(k,v){dial+='<tr about="'+htmlspecialchars(JSON.stringify(v))+'" key="'+k+'">';dial+='<td>'+((v.type=='dir')?'<span class="ui-icon ui-icon-folder-collapsed"></span>':((v.type=='kt')?'<span class="ui-icon ui-icon-calculator"></span>':'<span class="ui-icon ui-icon-document"></span>'))+'</td>';dial+='<td>'+v.viewname+'</td>';dial+='<td><button class="pastezwisch" title="Hier einfügen"><span class="ui-icon ui-icon-pin-s"></span></button></td>'
dial+='<td><button class="delzwisch" title="Aus Zwischenablage löschen"><span class="ui-icon ui-icon-trash"></span></button></td>';dial+='<td>'+((v.platz=='user')?'my:/':'pub:/')+v.filepath+v.filename+'</td>';dial+='</tr>'})}
else{dial+='<td colspan="5" id="tabempt"></td>'}
dial+='</table>';dial+='<small>Wählen Sie eine Datei, einen Ordner aus, um diesen hierhin ('+allgvars.proto+allgvars.path+') zu kopieren oder zu verschieben.</small>'
dial+='</div>';$("body").prepend(dial);if($("td#tabempt").length>0){show_error('Leer','Die Zwischenablage ist leer!',"td#tabempt")}
$("div.zwischenablage").dialog({modal:!0,responsive:!0,minWidth:500,buttons:{"Zwischenablage leeren":function(){localStorage.removeItem("daten_zwischenablage");$(this).dialog('close')},"Schließen":function(){$(this).dialog('close')}}});$("button.pastezwisch").unbind('click').click(function(){var data=$(this).parent('td').parent('tr').attr('about');var key=$(this).parent('td').parent('tr').attr('key');data=JSON.parse(data);if($("div.zwischenablagepaste").length){$("div.zwischenablagepaste").remove()}
var dial='<div class="zwischenablagepaste" title="Zwischenablage - Einfügen">';dial+='<h3>Verschieben &amp; kopieren</h3>';dial+='<input type="text" readonly="readonly" id="oldpath"> (Quelle)<br />';dial+='<input type="text" readonly="readonly" id="newpath"> (Zielverzeichnis)<br />';dial+='<input type="text" id="file"> ('+((data.type=='dir')?'Ordner':'Datei')+'name)<br />';if(data.type=='kt'){dial+='<i style="color:orange;"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span> Die Endung ".kimb_table" muss bestehen bleiben!</i><br />'}
else if(data.filename.substr(data.filename.length-9)=='.kimb_enc'){dial+='<i style="color:orange;"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span> Die Endung ".kimb_enc" muss bestehen bleiben!</i><br />'}
dial+='<i id="replaceatt" style="display:none; color:red;"><span class="ui-icon ui-icon-info"  title="Die Datei wird überschrieben, sofern Sie auf Los klicken!" style="display:inline-block;"></span> Dateiname schon vergeben</i><br />';dial+='<input type="radio" name="art" value="rename" checked="checked">  (verschieben)<br />';dial+='<input type="radio" name="art"  value="copy"> (kopieren) ';dial+='</div>';$("body").prepend(dial);$("div.zwischenablagepaste input#oldpath").val(((data.platz=='user')?'my:/':'pub:/')+data.filepath+data.filename);$("div.zwischenablagepaste input#newpath").val(allgvars.proto+allgvars.path);$("div.zwischenablagepaste input#file").val(data.filename);$("div.zwischenablagepaste input#file").unbind('change').change(finachanged);$("div.zwischenablagepaste input#file").unbind('keyup').keyup(finachanged);function finachanged(){var val=$("div.zwischenablagepaste input#file").val();$("div.zwischenablagepaste  i#replaceatt").css("display","none");$("div.main_files ul.files li").each(function(){var name=$(this).attr('url');if(name==val){$("div.zwischenablagepaste  i#replaceatt").css("display","block")}})}
finachanged();$("div.zwischenablagepaste").dialog({modal:!0,responsive:!0,minWidth:400,buttons:{"Los":function(){var infos={'verz':data.platz,'url':data.filepath+data.filename,'name':$("div.zwischenablagepaste input#file").val(),'art':$("div.zwischenablagepaste input[name=art]:checked").val(),};$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"zwischenabl","infos":infos}).always(function(data){if(data!=null&&data.main!=null&&data.main.versch){main_explorer();del_elem(key);$("div.zwischenablagepaste").dialog('close');$("div.zwischenablage").dialog('close')}
else{j_alert("Konnte nicht einfügen!")}})},"Abbrechen":function(){$(this).dialog('close')}}})});$("button.delzwisch").unbind('click').click(function(){var key=$(this).parent('td').parent('tr').attr('key');del_elem(key);makezwischenablagedial()});function del_elem(key){var zwisch=localStorage.getItem("daten_zwischenablage");zwisch=JSON.parse(zwisch);if(zwisch!=null&&typeof zwisch=="object"){zwisch.splice(key,1);var json=JSON.stringify(zwisch);if(json!="[]"&&json!=""){localStorage.setItem("daten_zwischenablage",json)}
else{localStorage.removeItem("daten_zwischenablage")}}}};$(document).on("contextmenu",'ul.files li',function(e){var name=$(this).attr('name');var url=$(this).attr('url');var ftype=$(this).attr('ftype');if(typeof name=="undefined"||typeof url=="undefined"||typeof ftype=="undefined"){return !1}
if($("div.delfile_explorer").length){$("div.delfile_explorer").remove()}
var dial='<div class="delfile_explorer" title="Dateieinstellungen">'
dial+='Möchten Sie "'+name+'" löschen?<br />';dial+='<span id="ja">Löschen</span>';dial+='<div class="delfile_explorer_satus" style="display:none;">Fehler</div>';dial+='<hr />';dial+='Möchten Sie sich "'+name+'" in der Zwischenablage merken?<br />';dial+='<small>(Kopieren, Verschieben, Umbenennen)</small><br />';dial+='<span id="merken">Merken</span>';dial+='<div class="zwiabfile_explorer_satus" style="display:none;"></div>';dial+='<hr />';if(allgvars.folder=='user'){dial+='Oder möchten Sie "'+name+'" via Link freigeben?<br />';dial+='<span id="frei">Freigeben</span>';if(ftype=='dir'){dial+='<br />';dial+='<small><input id="freigupload" type="checkbox" checked="checked"> Upload von Dateien in den freigegebenen Ordner erlauben.</small>'}}
else{dial+='Sie können nur Inhalte aus "Mein Verzeichnis" per Link freigeben!'}
dial+='</div>';$("body").prepend(dial);$("div.delfile_explorer").dialog({modal:!0,responsive:!0,buttons:{"Schließen":function(){$(this).dialog('close')}}});$("div.delfile_explorer span").button();$("div.delfile_explorer span#ja").click(function(){allgvars.file=url;$("div.delfile_explorer_satus").css({"display":"none"});$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"delfile"}).always(function(data){if(data!=null&&data.main!=null&&data.main.wr){main_explorer();$("div.delfile_explorer").dialog('close')}
else{$("div.delfile_explorer_satus").css({"display":"block","background-color":"red","padding":"5px","border-radius":"2px","color":"white"})}})});$("div.delfile_explorer span#merken").click(function(){$("div.zwiabfile_explorer_satus").css({"display":"none"});try{var about={'viewname':name,'filename':url,'type':ftype,'filepath':allgvars.path,'platz':allgvars.folder};var zwisch=localStorage.getItem("daten_zwischenablage");if(typeof zwisch=="undefined"||zwisch==''||zwisch==null){zwisch=new Array()}
else{zwisch=JSON.parse(zwisch)}
zwisch.push(about);zwisch=JSON.stringify(zwisch);localStorage.setItem("daten_zwischenablage",zwisch);$("div.zwiabfile_explorer_satus").html("Gemerkt");$("div.zwiabfile_explorer_satus").css({"display":"block","background-color":"green","padding":"5px","border-radius":"2px","color":"white"})}
catch(exception){$("div.zwiabfile_explorer_satus").html("Fehler");$("div.zwiabfile_explorer_satus").css({"display":"block","background-color":"red","padding":"5px","border-radius":"2px","color":"white"})}});$("div.delfile_explorer span#frei").click(function(){allgvars.file=url;if(ftype=='dir'){if($("input#freigupload:checked").length==1){var freigabeupload='yes'}
else{var freigabeupload='no'}}
else{var freigabeupload='no'}
make_freigabe(freigabeupload);$("div.delfile_explorer").dialog('close')});return !1})}
else{show_error('404','Ordner nicht gefunden!',"div.main_files")}}
else{show_error('404','Ordner nicht gefunden!',"div.main_files")}})}
var table_next_id;var global_table_passw;function open_table(url,name,adding){var data_okay=!1;if(typeof adding==='undefined'){adding=!1}
allgvars.file=url;global_table_passw='vqtxvpJJWiFJrNKcOQOjMgTHBxqGdiyuBhilfRktqfWLyHEw';open_table_get(name,adding,data_okay)}
function open_table_passw(_nextfunc,data_okay,data,adding,name){if($("div.j_promt").length){$("div.j_promt").remove()}
var dial='<div class="j_promt" title="Passwort benötigt!">'
dial+='Bitte geben Sie das Passwort für die Tabelle an!<br />';dial+='<input type="password" placeholder="Passwort" id="js_table_passw"><br />';dial+='<input type="checkbox" id="js_table_passw_save"> Passwort merken?<br />';dial+='<small>Lassen Sie das Feld für unverschlüsselte Tabellen leer.</small>';dial+='</div>';$("body").prepend(dial);var locpass=localStorage.getItem("global_table_passw");if(typeof locpass!="undefined"&&locpass!=null&&locpass!=''){$("input#js_table_passw").val(locpass);$("input#js_table_passw_save").prop('checked',!0)}
$("div.j_promt").dialog({modal:!0,responsive:!0,buttons:{"OK":function(){var pass=$("input#js_table_passw").val();if(pass!=''){global_table_passw=pass}
else{global_table_passw='vqtxvpJJWiFJrNKcOQOjMgTHBxqGdiyuBhilfRktqfWLyHEw'}
if($("input#js_table_passw_save:checked").length==1){localStorage.setItem("global_table_passw",global_table_passw)}
else{localStorage.removeItem("global_table_passw")}
$(this).dialog('close');if(typeof _nextfunc=="function"){_nextfunc(data_okay,data,adding,name)}},"Passwort zeigen":function(){$("input#js_table_passw").attr("type","text")}}})}
function open_table_get(name,adding,data_okay){function dec_anz(data,_callback){var passw=!1;try{data=sjcl.decrypt(global_table_passw,data);passw=!0}
catch(e){if(typeof _callback=="function"){_callback(e)}}
if(passw){data=JSON.parse(data);data_okay=!0;open_table_dialog(data_okay,data,adding,name)}}
if(adding){var data={"table":[[0,"Name","Vorname"],[1,"Meier","Heinze"]],"nextid":2};data_okay=!0;open_table_passw(open_table_dialog,data_okay,data,adding,name)}
else{$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"table"}).always(function(data){data=data.main;if(data!=null){data=JSON.parse(data);dec_anz(data,function(){var locpass=localStorage.getItem("global_table_passw");if(typeof locpass!="undefined"&&locpass!=null&&locpass!=''){global_table_passw=locpass;dec_anz(data,function(){open_table_passw(dec_anz,data,function(e){j_alert('Die Tabelle konnte mit diesem Passwort nicht entschlüsselt werden!\r\n(Fehlermeldung:"'+e.message+'")')})})}
else{open_table_passw(dec_anz,data,function(e){j_alert('Die Tabelle konnte mit diesem Passwort nicht entschlüsselt werden!\r\n(Fehlermeldung:"'+e.message+'")')})}})}
else{j_alert('Konnte die Tabelle nicht korrekt vom Server laden!')}})}}
function open_table_dialog(data_okay,data,adding,name){if(data_okay){table_next_id=data.nextid;data=data.table;make_table_html(data,'div.for_file_kimbta');$('div.for_file_kimbta').css('display','block');$('div.for_file_kimbta').dialog({width:720,modal:!0,responsive:!0,title:name,beforeClose:function(event,ui){global_table_passw=''}});if(adding){save_new_table(data);main_explorer()}}
else{j_alert("Fehler beim Lesen der Tabelle")}}
function open_file(url){var link=add_daten.siteurl+"/ajax.php?addon=daten&folder="+encodeURI(allgvars.folder)+"&path="+encodeURI(allgvars.path+url);if(url.substr(url.length-9)=='.kimb_enc'){$.get(link,function(data){if(data!=""){var dial='<div id="passw_file_prompt" title="Passwort!">';dial+='<input type="password" placeholder="Passwort" id="kimb_enc_passw"><br />'
dial+='<small><input type="checkbox" id="kimb_enc_klar"> Klartext</small><br />';dial+='<small>Bitte geben Sie das Passwort für diese Datei an!</small';dial+='</div>';$("body").append(dial);$("input#kimb_enc_klar").change(function(){if($("input#kimb_enc_klar:checked").length==1){$("input#kimb_enc_passw").attr("type","text")}
else{$("input#kimb_enc_passw").attr("type","password")}});$("div#passw_file_prompt").dialog({modal:!0,responsive:!0,buttons:{"Los":function(){var pass=$("input#kimb_enc_passw").val();try{var file=sjcl.decrypt(pass,data);saveAs(inline2Blob(file),url.substr(0,url.length-9));$(this).dialog('close')}
catch(e){j_alert('Konnte die Datei nicht entschlüsseln:<br />('+e.message+')');return}},"Schließen":function(){$(this).dialog('close')}},beforeClose:function(event,ui){$(this).remove()}})}
else{j_alert("Fehler beim Laden der Datei!")}})}
else{window.open(link,"_blank","width=900px,height=500px,top=20px,left=20px")}}
function make_table_html(data,domel){var html='<table width="100%" border="border">';$.each(data,function(k,v){html+='<tr>';if(k==0){$.each(v,function(sk,sv){if(sk==0){html+='<th k="'+k+'" sk="'+sk+'">'+sv+'</th>'}
else{html+='<th class="edit" k="'+k+'" sk="'+sk+'">'+sv+'</th>'}})}
else{$.each(v,function(sk,sv){if(sk==0){html+='<td k="'+k+'" sk="'+sk+'">'+sv+'</td>'}
else{html+='<td class="edit" k="'+k+'" sk="'+sk+'">'+sv+'</td>'}})}
html+='</tr>'});html+='</table>';html+='<button id="new_sp">Spalte hinzufügen</button><br />';html+='<button id="new_ze">Zeile hinzufügen</button><br />';html+='<small>Doppenklick zum Ändern; Alt zum Speichern; Ctrl zum Verwerfen; Rechtsklick zum Löschen/ Hinzufügen</small><br />';html+='<button id="exp_json">JSON Export</button>';html+='<button id="imp_json">JSON Import</button>';html+='<span class="add_daten_status" style="display:none;"></span>';$(domel).html(html);$("div.for_file_kimbta table td.edit, div.for_file_kimbta table th.edit").unbind('dblclick').dblclick(function(){var k=$(this).attr('k');var sk=$(this).attr('sk');var val=$(this).html();if(val.indexOf('<textarea style="width:95%;">')===-1){val=val.replace(/<br \/>/g,"\r\n");val=val.replace(/<br>/g,"\r\n");$(this).html('<textarea style="width:95%;">'+val+'</textarea>');$(this).children("textarea").keyup(function(event){if(event.keyCode==18){var newval=$(this).val();newval=newval.replace(/&/g,"&amp;");newval=newval.replace(/</g,"&lt;");newval=newval.replace(/>/g,"&gt;");newval=newval.replace(/\n/g,'<br />');newval=newval.replace(/\r/g,'<br />');newval=newval.replace(/\r\n/g,'<br />');$(this).parent().html(newval);data[k][sk]=newval;save_new_table(data)}
else if(event.keyCode==17){$(this).parent().html(val)}})}});$("button#new_sp").unbind('click').click(function(){new_spalte('end',data,domel)});$("button#new_ze").unbind('click').click(function(){new_reihe('end',data,domel)});$("button#exp_json ").unbind('click').click(function(){make_json(data)});$("button#imp_json ").unbind('click').click(function(){import_json()});$(document).on("contextmenu",'div.for_file_kimbta table td.edit',function(e){var k=$(this).attr('k');var sk=$(this).attr('sk');if($("div.rightclick_menue").length){$("div.rightclick_menue").remove()}
var menue='<div class="rightclick_menue" title="Tabelle hier anpassen">'
menue+='<button id="sp_add">Spalte hier hinzufügen</button><br />';menue+='<button id="ro_add">Reihe hier hinzufügen</button><br />';menue+='<small>Jeweils oberhalb bzw. links des angeklickten Kästchens</small><br/>';menue+='<button id="sp_del">Spalte hier löschen</button><br />';menue+='<button id="ro_del">Reihe hier löschen</button>';menue+='</div>';$("body").prepend(menue);$("div.rightclick_menue").dialog({modal:!0,responsive:!0});$("div.rightclick_menue button#sp_add").click(function(){new_spalte(sk,data,domel)});$("div.rightclick_menue button#ro_add").click(function(){new_reihe(k,data,domel)});$("div.rightclick_menue button#sp_del").click(function(){del_spalte(sk,data,domel)});$("div.rightclick_menue button#ro_del").click(function(){del_reihe(k,data,domel)});return !1});return !0}
function new_spalte(ort,data,domel){if(ort!='end'){ort=parseInt(ort)}
for(var i=0;i<data.length;i++){if(ort=='end'){data[i].push('Wert')}
else{data[i].splice(ort,0,"Wert")}}
make_table_html(data,domel);save_new_table(data);return}
function new_reihe(ort,data,domel){var array=new Array();if(ort!='end'){ort=parseInt(ort)}
for(var i=0;i<data[0].length;i++){array.push("Wert")}
array[0]=table_next_id;table_next_id++;if(ort=='end'){data.push(array)}
else{data.splice(ort,0,array)}
make_table_html(data,domel);save_new_table(data);return}
function del_spalte(ort,data,domel){ort=parseInt(ort);for(var i=0;i<data.length;i++){data[i].splice(ort,1)}
make_table_html(data,domel);save_new_table(data);return}
function del_reihe(ort,data,domel){ort=parseInt(ort);data.splice(ort,1);make_table_html(data,domel);save_new_table(data);return}
function make_json(data){var file=JSON.stringify({'table':data,'nextid':table_next_id});window.open("data:text/json;utf-8,"+file,"_blank","width=900px,height=500px,top=20px,left=20px,scrollbars=yes")}
function import_json(){if($("div.import_json").length){$("div.import_json").remove()}
var menue='<div class="import_json" title="JSON in die Tabelle importieren">'
menue+='Bitte geben Sie hier den JSON Code für die Tabelle an:<br />';menue+='<textarea id="json_impcode" placeholder=\'{"table":[[0,"Vorname","Name"],[1,"Max","Muster"],[2,"Maxa","Mustera"]],"nextid":3}\' rows="5" cols="20"></textarea><br />'
menue+='<small>Der Import ersetzt die aktuelle Tabelle!</small>';menue+='<span class="imp_daten_status" style="display:none;"></span>';menue+='</div>';$("body").prepend(menue);$("div.import_json").dialog({modal:!0,responsive:!0,buttons:{"Import Data":function(){var json=$("textarea#json_impcode").val();try{var data=JSON.parse(json)}
catch(e){$("span.imp_daten_status").html("Fehler");$("span.imp_daten_status").css({"display":"inline","background-color":"red","padding":"5px","border-radius":"2px","color":"white","float":"right"})}
if(typeof data==="object"){table_next_id=data.nextid;data=data.table;make_table_html(data,'div.for_file_kimbta');save_new_table(data);$("span.imp_daten_status").html("Importiert");$("span.imp_daten_status").css({"display":"inline","background-color":"green","padding":"5px","border-radius":"2px","color":"white","float":"right"});setTimeout(function(){$("div.import_json").dialog("close")},2000)}},"Abbrechen":function(){$(this).dialog("close")}}});return}
function save_new_table(data){$("span.add_daten_status").html("Speicherung ...");$("span.add_daten_status").css({"display":"inline","background-color":"orange","padding":"5px","border-radius":"2px","color":"white","float":"right"});data={"table":data,"nextid":table_next_id};data=sjcl.encrypt(global_table_passw,JSON.stringify(data));$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"tablesave","data":JSON.stringify(data)}).done(function(data){if(data.main.wr){$("span.add_daten_status").html("Gespeichert");$("span.add_daten_status").css({"background-color":"green"});setTimeout(function(){$("span.add_daten_status").css("display","none")},5000)}
else{$("span.add_daten_status").html("Fehler");$("span.add_daten_status").css({"background-color":"red"})}}).fail(function(){$("span.add_daten_status").html("Fehler");$("span.add_daten_status").css({"background-color":"red"})})}
function make_freigabe(upload){$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"allgvars":allgvars,"todo":"newfreigabe","upload":upload}).always(function(data){if(data.main.okay){j_alert('Die Datei wurde freigegeben.<br /><br /><input readonly="readonly" onclick="this.focus();this.select();" style="border:1px solid black; background-color:gray; text:white; width:100%;" value="'+data.main.link+'"><br /><br />Unter "Freigabe" sehen Sie alle Freigaben und können diese löschen!')}
else{j_alert('Die Freigabe schlug fehl!')}});return}
function show_freigaben(){window.location.hash="freig://list";$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"todo":"freigabeliste"}).always(function(data){if(typeof data.main=="undefined"){j_alert("Der Sever antwortet nicht korrekt!");return}
if(data.main.okay&&data.main.list!=null){var liste='<table class="freigaben" width="100%">';liste+='<tr>';liste+='<th>Art</th>';liste+='<th>Name</th>';liste+='<th colspan="3">Bearbeiten</th>';liste+='<th>Pfad</th>';liste+='</tr>';$.each(data.main.list,function(k,v){liste+='<tr fid="'+v.id+'" path="'+v.path+'">';liste+='<td><span class="ui-icon ui-icon-'+(v.type=='folder'?'folder-collapsed':'document')+'"></span>'+(v.upload=='yes'?'<span class="ui-icon ui-icon-arrowthickstop-1-n" title="Upload aktiviert"></span>':'')+'</td>';liste+='<td><span class="open_folder" title="Ordner mit Datei anzeigen">'+v.name+'</span></td>';liste+='<td><span class="show_link" title="Link zur Datei anzeigen"><span class="ui-icon ui-icon-link"></span></span></td>';liste+='<td><a href="'+v.link+'" target="_blank" title="Datei über Freigabelink öffnen"><span class="ui-icon ui-icon-extlink" style="display:inline-block"></span></a></td>';liste+='<td><span class="del_link" title="Freigabe löschen"><span class="ui-icon ui-icon-trash" style="display:inline-block"></span></span></td>';liste+='<td>my:/'+v.path+'</td>';liste+='</tr>'});liste+='</table>';$("div.main_files").html(liste);$("table.freigaben").tooltip();$("table.freigaben span.show_link").unbind('click').click(function(){var link=$(this).parent().parent().find('td a').attr('href');j_alert('Die Datei wurde freigegeben.<br /><br /><input readonly="readonly" onclick="this.focus();this.select();" style="border:1px solid black; background-color:gray; text:white; width:100%;" value="'+link+'"><br /><br />Unter "Freigabe" sehen Sie alle Freigaben und können diese löschen!')});$("table.freigaben span.del_link").unbind('click').click(function(){var id=$(this).parent().parent().attr('fid');$.post(add_daten.siteurl+"/ajax.php?addon=daten",{"todo":"freigabedel","id":id}).always(function(data){if(data!=null&&data.main!=null&&data.main.okay){j_alert('Die Freigabe wurde gelöscht!');show_freigaben()}
else{j_alert('Die Freigabe konnte nicht gelöscht werden!')}})});$("table.freigaben span.open_folder").unbind('click').click(function(){var path=$(this).parent().attr('path');allgvars.folder='user';allgvars.path=path.replace(/\\/g,'/').replace(/\/[^\/]*\/?$/,'')+'/';main_explorer()})}
else{show_error('404','Keine Freigaben gefunden!',"div.main_files")}});return}
var anzahl;var touchbar_status=!0;function shall_do_fileload(){return touchbar_status};function trigger_touchbedienung(art,elem,code){if(anzahl==1){anzahl++;if(art==0){$(elem).trigger("contextmenu")}
else if(art==1){$(elem).trigger("dblclick")}
else if(art==2){var touche=$.Event('keyup');touche.keyCode=code;$(elem).trigger(touche)}
else{return !1}}
else{return !1}}
$(function(){if(("ontouchstart" in window)||(navigator.msMaxTouchPoints>0)){var html='<div style="position:fixed; bottom:0; right:30px; z-index:999999; min-width:410px; max-width:100%; min-height:30px; background-color:black; padding:10px; border-top-left-radius:5px; border-top-right-radius:5px;">';html+='<span id="touchbed_butt">';html+='<input type="radio" id="alt" name="butt">';html+='<label for="alt">Alt</label>';html+='<input type="radio" id="strg" name="butt">';html+='<label for="strg">Strg</label>';html+='<input type="radio" id="enter" name="butt">';html+='<label for="enter">Enter</label>';html+='<input type="radio" id="dopp" name="butt">';html+='<label for="dopp">Doppelklick</label>';html+='<input type="radio" id="rec" name="butt">';html+='<label for="rec">Rechtsklick</label>';html+='</span>'
html+='<span id="touchbed_clo" title="Schließen">&darr;</span>'
html+='<br /><small style="color:white;">Button und dann Stelle für den Befehl anklicken</small>';html+='</div>';$('body').append(html);$("#touchbed_butt").buttonset();$("#touchbed_clo").button();$("#touchbed_clo").tooltip();$("#touchbed_butt input[type=radio]").unbind('click').click(function(){var id=$(this).attr('id');anzahl=1;touchbar_status=!1;$("#touchbed_butt").buttonset('disable');$("td.edit").unbind('click').click(function(){var elem;if(id=='alt'){elem=$(this).children('textarea');trigger_touchbedienung(2,elem,18)}
else if(id=='strg'){elem=$(this).children('textarea');trigger_touchbedienung(2,elem,17)}
else if(id=='dopp'){trigger_touchbedienung(1,this)}
else if(id=='rec'){trigger_touchbedienung(0,this)}
$("#touchbed_butt").buttonset('enable');touchbar_status=!0});$("#new_name").unbind('click').click(function(){if(id=='strg'){trigger_touchbedienung(2,this,17)}
else if(id=='enter'){trigger_touchbedienung(2,this,13)}
$("#touchbed_butt").buttonset('enable');touchbar_status=!0});$("ul.files li").click(function(e){if(id=='rec'){trigger_touchbedienung(0,this)}
$("#touchbed_butt").buttonset('enable');touchbar_status=!0})});$("#touchbed_clo").click(function(){$(this).parent().hide("blur")})}})
