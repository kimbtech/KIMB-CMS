$(function(){makestructur();loadsite()});var structur={main:"div#addon_survey_main"}
var ajaxpost={data:{},task:'umfrage',uid:addsur.uid}
function makestructur(){var struc='<div id="meldungen"></div>'+'<div id="navigation"></div>'+'<div id="fragen"></div>'+'<div id="auswertung"></div>';structur.fra="div#fragen";structur.nav="div#navigation";structur.aus="div#auswertung";structur.mel="div#meldungen"
var loader='<div id="daten_loading" style="display:none;">';loader+='<div style="position:fixed; top:0; left:0; z-index:50; background-color:gray; opacity:0.5; width:100%; height:100%;">';loader+='</div>';loader+='<div style="position:fixed; top:calc( 50% - 64px ); left:calc( 50% - 64px ); background-color:#5d7; border-radius:20px; padding:15px; z-index:51;">';loader+='<img src="'+addsur.su+'/load/system/spin_load.gif" title="Lädt!!" alt="Lädt!!">';loader+='</div>';loader+='</div>';struc+=loader;$(document).bind("ajaxSend",function(){$("#daten_loading").show("highlight")}).bind("ajaxComplete",function(){$("#daten_loading").hide("highlight")});$(structur.main).html(struc);$("#daten_loading").hide("highlight");$(structur.fra).css('display','none');$(structur.aus).css('display','none')}
function loadsite(){var html='<button class="umf_nav_butt" todo="start">Umfrage starten</button>';html+='<button class="umf_nav_butt" todo="ergeb">Ergebnisse ansehen</button>';$(structur.nav).html(html);if(addsur.zugaus!="allowed"){$("button.umf_nav_butt[todo=ergeb]").css('display','none');$(structur.nav).append('<span class="fakebutton">Kein Zugriff auf die Auswertung</span>')}
if(addsur.zugriff!="allowed"){$("button.umf_nav_butt[todo=start]").css('display','none');$(structur.nav).prepend('<span class="fakebutton">Keine Rechte zur Teilnahme</span>')}
$("button.umf_nav_butt").click(function(){$(structur.fra).css('display','none');$(structur.aus).css('display','none');$("button.umf_nav_butt").each(function(k,v){$(this)[0].disabled=!1})
$(this)[0].disabled=!0;var todo=$(this).attr("todo");if(todo=='start'){ajaxpost.task='umfrage';start_umf()}
else if(todo='ergeb'){ajaxpost.task='auswertung';make_ergeb()}})}
var errortimeout;function errormessage(meldung){clearTimeout(errortimeout);$(structur.mel).html('<div class="surveyerrorbox"><p>'+meldung+'</p><p><button id="closeerrboxsur">Schließen</button></p></div>');$("button#closeerrboxsur").click(function(){$(structur.mel).html('')});errortimeout=setTimeout(function(){$(structur.mel).html('')},5000)}
function ajaxrequest(padd,elem){if(typeof elem==="function"){var cb=!0}
else{var cb=!1}
ajaxpost.data=padd;$.post(addsur.su+"/ajax.php?addon=survey",ajaxpost).always(function(output){if(typeof output.data=="undefined"||typeof output.okay!="boolean"||typeof output.error!="boolean"){errormessage("Der Sever antwortet nicht korrekt!")}
else{if(output.error||!output.okay){errormessage('Es gab einen Fehler mit dem Request!')}
else{var data=output.data;if(data!=null){if(cb){elem(data)}
else{$(elem).html(data)}}}}})}
var ergebnisse={};var thisfrage=0;var thisfragen=[0];var thisfrageid=0;var fragendata={};if(localStorage.getItem("survey_"+addsur.uid+"_ergebnisse")!=null){ergebnisse=JSON.parse(localStorage.getItem("survey_"+addsur.uid+"_ergebnisse"))}
function start_umf(){$(structur.fra).css("display","block");var html='<div id="fragearea"></div>'+'<hr />'+'<div id="fragenav"></div>';$(structur.fra).html(html);structur.franav=structur.fra+" div#fragenav";structur.fraarea=structur.fra+" div#fragearea";ajaxrequest({action:"pull"},umfragedo)}
function umfragedo(data){fragendata=data;thisfragen=[0].concat(Object.keys(fragendata.fragen));thisfrageid=0;var html='<div class="infotext">'+data.about+'</div>';if(data.art=="na"){html+='<div class="namefeld">'+'<p>Diese Umfrage ordnet die Ergebnisse Ihrem Namen zu.</p>'+'<p>Bitte geben Sie Ihren Namen an: <input type="text" placeholder="Name" id="umf_teilnehmername" value="'+addsur.username+'"></p>'
'</div>'}
else{html+='<div class="namefeld">'+'<p>Dies ist eine anonyme Umfrage!</p>'+'</div>'}
$(structur.fraarea).html(html);$(structur.franav).html('<button class="umfdobutt center" name="los">Los</button>'+'<span class="fragenzahl">'+thisfrageid+'/'+data.fragenzahl+'</span>'+'<div class="umfdobutt center"><button class="umfdobutt" name="back">&larr; Zurück</button>'+'<button class="umfdobutt" name="fwd">Weiter &rarr;</button></div>'+'<button class="umfdobutt center" name="end">Abschicken</button>');$("div.umfdobutt.center button.umfdobutt").each(function(k,v){$(this)[0].disabled=!0});$("button.umfdobutt[name=end]")[0].disabled=!0;$("button.umfdobutt").unbind('click').click(function(){var name=$(this).attr("name");save_frage(name);if(name=="los"){$("button.umfdobutt[name=los]")[0].disabled=!0;if(data.art=="na"){var name=$("input#umf_teilnehmername").val();if(name==""){errormessage('Sie müssen eine Namen angeben!');start_umf()}
else{ergebnisse.name=name}}
thisfrageid=1;load_frage(thisfragen[thisfrageid])}
else if(name=="fwd"){thisfrageid++;load_frage(thisfragen[thisfrageid])}
else if(name=="back"){thisfrageid--;load_frage(thisfragen[thisfrageid])}
else if(name=="end"){if(Object.keys(ergebnisse).length==fragendata.fragenzahl||(data.art=="na"&&Object.keys(ergebnisse).length==fragendata.fragenzahl+1)){function delall(data){if(data.pushokay){ergebnisse={};addsur.zugriff="notallowed";localStorage.removeItem("survey_"+addsur.uid+"_ergebnisse");fragendata={};var meld="<p>Vielen Dank für die Teilnahme.</p>";meld+='<p><button id="closeumfrage">Schließen</button></p>';$(structur.fraarea).html(meld);$("button.umfdobutt[name=back]")[0].disabled=!0;$("button.umfdobutt[name=fwd]")[0].disabled=!0;$("button.umfdobutt[name=los]")[0].disabled=!0;$("button.umfdobutt[name=end]")[0].disabled=!0;$("button#closeumfrage").click(function(){loadsite();$(structur.fra).css('display','none')})}
else{errormessage("Konnte Ihre Ergebnisse nicht senden.")}}
ajaxrequest({action:"push",erg:ergebnisse},delall)}
else{errormessage("Sie müssen alle Fragen beantworten, erst dann dürfen Sie absenden!")}}
$("button.umfdobutt[name=fwd]")[0].disabled=(thisfrageid==fragendata.fragenzahl?!0:!1);$("button.umfdobutt[name=end]")[0].disabled=(thisfrageid==fragendata.fragenzahl?!1:!0);$("button.umfdobutt[name=back]")[0].disabled=(thisfrageid<=1?!0:!1);if(thisfrageid!=fragendata.fragenzahl){$("button.umfdobutt[name=end]")[0].disabled=((Object.keys(ergebnisse).length==fragendata.fragenzahl||(fragendata.art=="na"&&Object.keys(ergebnisse).length==fragendata.fragenzahl+1))?!1:!0)}})}
function load_frage(nummer){thisfrage=nummer;$(structur.franav+" span.fragenzahl").text(thisfrageid+'/'+fragendata.fragenzahl);var frage=fragendata.fragen[nummer];var html='<div id="fragetext">';html+=frage.frage;html+='</div>';if(frage.type=='za'){if(typeof ergebnisse[nummer]!=="undefined"){var erge=ergebnisse[nummer]}
else{var erge=''}
html+='<div id="felder">';html+='<input type="number" min="'+frage.felder[1]+'" max="'+frage.felder[2]+'" class="savefeld" placeholder="Zahl" value="'+erge+'">';html+='<p>Geben Sie eine Zahl zwischen '+frage.felder[1]+' und '+frage.felder[2]+' ein.</p>';html+='</div>'}
else if(frage.type=='ft'){if(typeof ergebnisse[nummer]!=="undefined"){var erge=ergebnisse[nummer]}
else{var erge=''}
html+='<div id="felder">';html+='<textarea class="savefeld" style="width:90%; height:100px;">'+erge+'</textarea>'
html+='<p>Geben Sie einen Text ein. (optional)</p>'
html+='<p><input type="checkbox" id="freitextdeak"> Das Feld leer lassen.</p>'
html+='</div>'}
else if(frage.type=='ab'){html+='<div id="felder">';html+='<table>';html+='<td width="50%;"></td>';html+='<td>Sehr gut</td>';html+='<td>Gut</td>';html+='<td>Befriedigend</td>';html+='<td>Ausreichend</td>';html+='<td>Mangelhaft</td>';html+='<td>Ungenügend</td>';html+='<td>Keine Angabe</td>';$.each(frage.felder,function(k,v){var hchecked={1:"",2:"",3:"",4:"",5:"",6:"",ka:""}
if(typeof ergebnisse[nummer]!=="undefined"){hchecked[ergebnisse[nummer][k]]='checked="checked"'}
html+='<tr>';html+='<td>'+v+'</td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="1" '+hchecked[1]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="2" '+hchecked[2]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="3" '+hchecked[3]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="4" '+hchecked[4]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="5" '+hchecked[5]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="6" '+hchecked[6]+'></td>';html+='<td><input type="radio" class="savefeld" name="'+k+'" value="ka" '+hchecked.ka+'></td>';html+='</tr>'});html+='</table>';html+='<p>Bitte wählen Sie für jede Zeile ein Feld aus.</p>'
html+='</div>'}
else{html+='<div id="felder">';html+='<ul style="list-style-type:none;">';if(frage.type=='mc'){type='checkbox'
name='mc[]'}
else{type='radio'
name='au'}
$.each(frage.felder,function(k,v){if(typeof ergebnisse[nummer]!=="undefined"){var erge=ergebnisse[nummer];if(frage.type=='mc'){if(erge.indexOf(k)!=-1){erge='checked="checked"'}
else{erge=''}}
else{if(k==erge){erge='checked="checked"'}
else{erge=''}}}
else{var erge=''}
html+='<li>';html+='<input type='+type+' value="'+k+'" name="'+name+'" class="savefeld" '+erge+'>'+v;html+='</li>'});html+='</ul>';if(frage.type=='mc'){html+='<p>Wählen Sie passende Felder.</p>'}
else{html+='<p>Wählen Sie genau ein Feld.</p>'}
html+='</div>'}
$(structur.fraarea).html(html);if(frage.type=='ft'){if(erge=="ka"){$("textarea.savefeld")[0].disabled=!0;$("input#freitextdeak")[0].checked=!0}
$("input#freitextdeak").click(function(){if($(this).is(':checked')){$("textarea.savefeld").val("ka");$("textarea.savefeld")[0].disabled=!0}
else{$("textarea.savefeld")[0].disabled=!1;$("textarea.savefeld").val("")}})}}
function save_frage(butttask){if(thisfrageid!==0){var frage=fragendata.fragen[thisfrage];var fehlermess=!1;if(frage.type=='ft'||frage.type=='za'||frage.type=='au'){if(frage.type=='au'){var inh=$(".savefeld:checked").val()}
else{var inh=$(".savefeld").val()}
if(typeof inh!="undefined"&&inh!=""){ergebnisse[thisfrage]=inh}
else{fehlermess=!0}}
else if(frage.type=="mc"){var saved=[];$(".savefeld:checked").each(function(k,v){var key=$(this).val();saved.push(key)});if(saved.length>0){ergebnisse[thisfrage]=saved}
else{fehlermess=!0}}
else if(frage.type=="ab"){var saved={};$(".savefeld:checked").each(function(k,v){var val=$(this).val();var name=$(this).attr('name');saved[name]=val});if(Object.keys(frage.felder).length==Object.keys(saved).length){ergebnisse[thisfrage]=saved}
else{fehlermess=!0}}
if(fehlermess){errormessage("Sie müssen etwas eingeben bzw. auswählen!");if(butttask=='fwd'){thisfrageid--}
else if(butttask=='back'){thisfrageid++}}
localStorage.setItem("survey_"+addsur.uid+"_ergebnisse",JSON.stringify(ergebnisse))}}